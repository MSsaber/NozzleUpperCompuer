/*************************************************************
                      ESP8266????

???????ESP8266?????

?????????
***************************************************************/
#ifndef _ESP8266_H_
#define _ESP8266_H_
#include <reg52.h>
#include <Lcd1602.h>
#include <string.h>
#include <stdio.h>

#define uchar unsigned char
#define uint unsigned int

sbit key_skip=P2^2;

/*******************ESP8266?????????********************/
code uchar CWMODE[]		="AT+CWMODE=3\r\n\0";
code uchar CWLAP[]		="AT+CWLAP\r\n\0";	 
code uchar CWJAP2[]	    ="AT+CWJAP=\"11223344\",\"11223344\"\r\n\0";
code uchar CIPMUX[]	    ="AT+CIPMUX=0\r\n\0";
code uchar CIPMODE[]	="AT+CIPMODE=1\r\n\0";
code uchar CIPSTART[]   ="AT+CIPSTART=\"TCP\",\"115.29.109.104\",6544\r\n\0";
code uchar CIPSEND[]	="AT+CIPSEND\r\n\0";
/*********************ESP8266????????***********************/
#define MAXCHAR 100	              //???›¥???????
uchar xdata ESP8266_data[MAXCHAR];//?›¥?????????
uchar data_num=0;				  //????????????????????
bit ESP8266_f=0;				  //=1????????????
/*********************ESP8266????????***********************/
void ESP8266_delayms(uint ms);		 //???????????
void ESP8266_send_char(uchar ch);    //???????
void ESP8266_send_string(uchar *str);//?????????
bit Hand(uchar *a);			//?§Ø????????????????????a
void clearBuff();           //??????????
void ESP8266_zhuce();       //ESP8266???¨°???
void ESP8266_init();        //ESP8266????????

/********************************************************
????????:void ESP8266_delayms(uint ms)
????????:??????????
???????:ms???????????
********************************************************/
void ESP8266_delayms(uint ms)
{
	unsigned char i=100,j;
	for(;ms;ms--)
	{
		while(--i)
		{
			j=10;
			while(--j);
		}
	}
}
/***********************************************************
?????????void ESP8266_send_char(uchar ch)
???????????????????ch
?????????
***********************************************************/
void ESP8266_send_char(uchar ch)
{
    SBUF=ch;     //????????
    while(TI!=1);//??????????
    TI=0;        //????????
}

/***********************************************************
?????????ESP8266_send_string
??????????????????*str
?????????
***********************************************************/
void ESP8266_send_string(uchar *str)
{
  while(*str!='\0')           //??????§Ù?????
  {
      ESP8266_send_char(*str);//??????????????
      str++;					//???????+1
  }
	//ESP8266_send_string(CIPSEND);
}
/********************************************************
????????:void ser() interrupt 4
????????:?????§Ø????
???????:
********************************************************/
void ser() interrupt 4
{
	uchar i=0;
	ES=0;//????????§Ø?
	while(i<200)	   //?????§Ô??
	{
	    if(RI==1)	   //????????????????
	    {  
	        RI=0;      //????????????§Ø???
			if(data_num<MAXCHAR)//?????????????
			{
				ESP8266_data[data_num]=SBUF;//?????????????›¥????????
				data_num++; 	//??????????????+1
			}
			i=0;				//???????
	    }
		i++;					//????????+1
	}
	ESP8266_f=1;				//???????????????
	ES=1;//?????????§Ø?
}
/********************************************************
????????:void clearBuff(void)
????????:ESP8266???????????
???????:
********************************************************/
void clearBuff(void)
{
    for(data_num=0;data_num<MAXCHAR;data_num++)//????????????????0
    {
        ESP8266_data[data_num]=0x00;
    }
    data_num=0;	//????????????????
	ESP8266_f=0;//????????????
}
/********************************************************
????????:bit Hand(uchar *a)
????????:?§Ø????????????????????a
???????:????1?§µ?0???
********************************************************/
bit Hand(uchar *a)
{
	if(strstr(ESP8266_data,a)!=NULL)
		return 1;
	else
		return 0;																		  
}
/********************************************************
????????:void ESP8266_zhuce()
????????:ESP8266???¨°???
???????:
********************************************************/
void ESP8266_zhuce()
{
	lcd1602_write_character(0,1,"IP115.29.109.104");
	lcd1602_write_character(0,2,"Port:6544       ");

	ESP8266_delayms(150); 
	lcd1602_write_character(0,2,"ESP8266 init... ");

	ES=1;//?????????§Ø?
	//???? AP ?? STA ??????
	clearBuff();	   //???????
	lcd1602_write_character(0,2,"Set AP and STA  ");
	ESP8266_send_string(CWMODE);
	while(!Hand("OK")&&key_skip);

	//???? wifi
	clearBuff();	   //???????
	lcd1602_write_character(0,2,"Connect the WIFI");
	ESP8266_send_string(CWJAP2);
	while(!(Hand("OK")||Hand("FAIL"))&&key_skip);

	//????????????????
	if(Hand("FAIL"))
	{
		lcd1602_write_character(0,1,"Connection fails");
		lcd1602_write_character(0,2,"Please open WIFI");
	
		while(!Hand("OK")&&key_skip)
		{
			clearBuff();	   //???????
			ESP8266_send_string(CWJAP2);
			while(!(Hand("OK")||Hand("FAIL"))&&key_skip);
		}
		lcd1602_write_character(0,1,"ESP8266 init... ");	
	}

	//?????????
	clearBuff();	   //???????
	lcd1602_write_character(0,2,"Set single link ");
	ESP8266_send_string(CIPMUX);
	while(!Hand("OK")&&key_skip);

	//?????????
	clearBuff();	   //???????
	lcd1602_write_character(0,2,"Set passthrough ");
	ESP8266_send_string(CIPMODE);
	while(!Hand("OK")&&key_skip);

	//??????????????
	clearBuff();	   //???????
	lcd1602_write_character(0,2,"Connect server  ");
	ESP8266_send_string(CIPSTART);
	while(!Hand("OK")&&key_skip);

	//???¡Â???????
	clearBuff();	   //???????
	lcd1602_write_character(0,2,"Set send data   ");
	ESP8266_send_string(CIPSEND);
	while(!Hand(">")&&key_skip);

	LCD_write_command(0x01);
	delay_n40us(100);
}

/***********************************************************
?????????ESP8266_init
?????????ESP8266????????
?????????
***********************************************************/
void ESP8266_init()
{
    SCON = 0x50 ;  //UART???1??8¦Ë?????????????
    TMOD |= 0x20 ; //?????1???2,8¦Ë??????
    PCON |= 0x80 ; //SMOD=1;
    TH1 = 0xFA ;   //Baud:9600 fosc=11.0592MHz
    TL1=0xFA;
    TR1 = 1 ;      // timer 1 run
    ES=0;		   //???????§Ø?
	EA=1;		   //???????§Ø?

	ESP8266_zhuce();//ESP8266???¨°???
}
#endif